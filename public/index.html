<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Helix Listen</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <!-- PDF.js for client-side PDF extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e8e8e8;
      padding: 20px;
      padding-bottom: 100px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tagline {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }

    .input-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 8px;
    }

    input[type="text"], input[type="url"], textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 16px;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #e94560;
    }

    .file-input-wrapper {
      position: relative;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 16px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-input-label:hover {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.1);
    }

    .file-input-label.has-file {
      border-style: solid;
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }

    input[type="file"] {
      display: none;
    }

    .divider {
      text-align: center;
      color: #666;
      margin: 15px 0;
      font-size: 0.8rem;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .tab {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: #888;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: rgba(233, 69, 96, 0.2);
      color: #e94560;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .option {
      flex: 1;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #e94560;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(233, 69, 96, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      display: none;
    }

    .status.loading {
      display: block;
      background: rgba(233, 69, 96, 0.1);
      border: 1px solid rgba(233, 69, 96, 0.3);
    }

    .status.error {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    .status.success {
      display: block;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }

    .player-section {
      display: none;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }

    .player-section.visible {
      display: block;
    }

    .article-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: #fff;
    }

    .article-meta {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 15px;
    }

    audio {
      width: 100%;
      margin-top: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .download-btn {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .download-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      max-width: 500px;
      margin: 0 auto;
      background: #2a2a4a;
      padding: 15px 20px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .install-prompt.visible {
      display: flex;
    }

    .install-prompt p {
      flex: 1;
      font-size: 0.9rem;
    }

    .install-prompt button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .install-btn {
      background: #e94560;
      color: white;
    }

    .dismiss-btn {
      background: transparent;
      color: #888;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #666;
      font-size: 0.8rem;
    }

    .footer a {
      color: #e94560;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .hint {
      font-size: 0.75rem;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéß Helix Listen</h1>
    <p class="tagline">Turn any article or PDF into audio</p>

    <div class="input-section">
      <!-- Input Type Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="url">URL</button>
        <button class="tab" data-tab="pdf">PDF</button>
        <button class="tab" data-tab="text">Paste Text</button>
      </div>

      <!-- URL Tab -->
      <div class="tab-content active" id="tab-url">
        <div class="input-group">
          <label for="url-input">Paste article URL</label>
          <input type="url" id="url-input" placeholder="https://example.com/article">
          <p class="hint">Works best with blogs, news sites without paywalls</p>
        </div>
      </div>

      <!-- PDF Tab -->
      <div class="tab-content" id="tab-pdf">
        <div class="input-group">
          <label>Upload a PDF</label>
          <div class="file-input-wrapper">
            <label class="file-input-label" id="file-label" for="pdf-input">
              <span>üìÑ</span>
              <span id="file-name">Choose PDF file</span>
            </label>
            <input type="file" id="pdf-input" accept=".pdf">
          </div>
        </div>
      </div>

      <!-- Text Tab -->
      <div class="tab-content" id="tab-text">
        <div class="input-group">
          <label for="text-input">Paste your text</label>
          <textarea id="text-input" placeholder="Paste article text here..."></textarea>
        </div>
      </div>

      <div class="options">
        <div class="option">
          <label for="voice-select">Voice</label>
          <select id="voice-select">
            <option value="alloy">Alloy (Neutral)</option>
            <option value="echo">Echo (Male)</option>
            <option value="fable">Fable (British)</option>
            <option value="onyx">Onyx (Deep)</option>
            <option value="nova">Nova (Female)</option>
            <option value="shimmer">Shimmer (Soft)</option>
          </select>
        </div>
        <div class="option">
          <label for="speed-select">Speed</label>
          <select id="speed-select">
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary" id="convert-btn">
        <span>üéôÔ∏è</span>
        <span>Convert to Audio</span>
      </button>

      <div class="status" id="status"></div>
    </div>

    <div class="player-section" id="player-section">
      <div class="article-title" id="article-title"></div>
      <div class="article-meta" id="article-meta"></div>
      <audio id="audio-player" controls></audio>
      <button class="btn download-btn" id="download-btn">
        <span>‚¨áÔ∏è</span>
        <span>Download MP3</span>
      </button>
    </div>

    <footer class="footer">
      Suhit Anantula | <a href="https://suhitanantula.com" target="_blank">suhitanantula.com</a>
    </footer>
  </div>

  <div class="install-prompt" id="install-prompt">
    <p>Install Helix Listen for quick access from your home screen</p>
    <button class="dismiss-btn" id="dismiss-install">Later</button>
    <button class="install-btn" id="install-btn">Install</button>
  </div>

  <script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Elements
    const urlInput = document.getElementById('url-input');
    const pdfInput = document.getElementById('pdf-input');
    const textInput = document.getElementById('text-input');
    const fileLabel = document.getElementById('file-label');
    const fileName = document.getElementById('file-name');
    const voiceSelect = document.getElementById('voice-select');
    const speedSelect = document.getElementById('speed-select');
    const convertBtn = document.getElementById('convert-btn');
    const status = document.getElementById('status');
    const playerSection = document.getElementById('player-section');
    const articleTitle = document.getElementById('article-title');
    const articleMeta = document.getElementById('article-meta');
    const audioPlayer = document.getElementById('audio-player');
    const downloadBtn = document.getElementById('download-btn');

    let currentAudioBlob = null;
    let currentTitle = '';
    let activeTab = 'url';

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        document.getElementById(`tab-${activeTab}`).classList.add('active');
      });
    });

    // Handle PDF file selection
    pdfInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        fileName.textContent = file.name;
        fileLabel.classList.add('has-file');
      }
    });

    // Extract text from PDF using PDF.js (client-side)
    async function extractPdfText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }

      return fullText.trim();
    }

    // Convert button handler
    convertBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      const pdfFile = pdfInput.files[0];
      const pastedText = textInput.value.trim();

      // Check based on active tab
      if (activeTab === 'url' && !url) {
        showStatus('Please enter a URL', 'error');
        return;
      }
      if (activeTab === 'pdf' && !pdfFile) {
        showStatus('Please upload a PDF', 'error');
        return;
      }
      if (activeTab === 'text' && !pastedText) {
        showStatus('Please paste some text', 'error');
        return;
      }

      convertBtn.disabled = true;
      convertBtn.innerHTML = '<div class="spinner"></div><span>Processing...</span>';
      playerSection.classList.remove('visible');

      try {
        let extracted;

        if (activeTab === 'text') {
          // Direct text - skip extraction API
          const wordCount = pastedText.split(/\s+/).length;
          extracted = {
            title: 'Pasted Text',
            text: pastedText,
            wordCount,
            estimatedMinutes: Math.ceil(wordCount / 150),
          };
        } else if (activeTab === 'pdf') {
          // Extract PDF text client-side
          showStatus('Extracting text from PDF...', 'loading');
          const pdfText = await extractPdfText(pdfFile);

          if (!pdfText || pdfText.length < 50) {
            throw new Error('Could not extract text from PDF. The file may be scanned or image-based.');
          }

          const wordCount = pdfText.split(/\s+/).length;
          extracted = {
            title: pdfFile.name.replace('.pdf', ''),
            text: pdfText,
            wordCount,
            estimatedMinutes: Math.ceil(wordCount / 150),
          };
        } else {
          // URL - use server-side extraction
          showStatus('Extracting article...', 'loading');

          const extractRes = await fetch('/api/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url }),
          });

          const responseText = await extractRes.text();

          try {
            extracted = JSON.parse(responseText);
          } catch (e) {
            console.error('Response was not JSON:', responseText.substring(0, 200));
            throw new Error('Server error. The site may be blocking access. Try pasting the text directly.');
          }

          if (!extractRes.ok) {
            throw new Error(extracted.error || 'Failed to extract article');
          }
        }

        currentTitle = extracted.title;

        // Step 2: Convert to speech
        const voice = voiceSelect.value;
        const speed = parseFloat(speedSelect.value);

        // Split text into chunks
        const maxChunkSize = 4000;
        const textChunks = [];
        const fullText = extracted.text;

        for (let i = 0; i < fullText.length; i += maxChunkSize) {
          textChunks.push(fullText.slice(i, i + maxChunkSize));
        }

        showStatus(`Converting to audio (0/${textChunks.length} parts)...`, 'loading');

        // Fetch chunk function
        const fetchChunk = async (index) => {
          const speakRes = await fetch('/api/speak', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: textChunks[index],
              voice,
              speed,
            }),
          });

          if (!speakRes.ok) {
            const errText = await speakRes.text();
            let errMsg = 'Failed to generate speech';
            try {
              const errJson = JSON.parse(errText);
              errMsg = errJson.error || errMsg;
            } catch (e) {}
            throw new Error(errMsg);
          }

          return speakRes.blob();
        };

        // Load all chunks in parallel with progress
        const audioChunks = new Array(textChunks.length);
        let loadedCount = 0;

        await Promise.all(textChunks.map((_, index) =>
          fetchChunk(index).then(blob => {
            audioChunks[index] = blob;
            loadedCount++;
            showStatus(`Converting to audio (${loadedCount}/${textChunks.length} parts)...`, 'loading');
          })
        ));

        // Combine all chunks into one audio file
        currentAudioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
        const audioUrl = URL.createObjectURL(currentAudioBlob);

        // Update player
        articleTitle.textContent = extracted.title;
        articleMeta.textContent = `${extracted.wordCount} words ‚Ä¢ ~${extracted.estimatedMinutes} min`;
        audioPlayer.src = audioUrl;
        playerSection.classList.add('visible');

        showStatus('Ready to play!', 'success');

        // Auto-play
        audioPlayer.play().catch(() => {
          showStatus('Tap play to start', 'success');
        })

      } catch (error) {
        console.error(error);
        showStatus(error.message, 'error');
      } finally {
        convertBtn.disabled = false;
        convertBtn.innerHTML = '<span>üéôÔ∏è</span><span>Convert to Audio</span>';
      }
    });

    // Download handler
    downloadBtn.addEventListener('click', () => {
      if (!currentAudioBlob) return;

      const url = URL.createObjectURL(currentAudioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentTitle.replace(/[^a-z0-9]/gi, '_')}.mp3`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Helper functions
    function showStatus(message, type) {
      status.textContent = message;
      status.className = 'status ' + type;
    }

    // Handle share target and extension parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Check for text from extension
    const extensionText = urlParams.get('text');
    const extensionTitle = urlParams.get('title');
    const extensionVoice = urlParams.get('voice');
    const extensionSpeed = urlParams.get('speed');
    const autoplay = urlParams.get('autoplay');

    if (extensionText) {
      // Switch to text tab and fill in
      document.querySelector('[data-tab="text"]').click();
      textInput.value = decodeURIComponent(extensionText);

      if (extensionVoice) voiceSelect.value = extensionVoice;
      if (extensionSpeed) speedSelect.value = extensionSpeed;

      // Auto-convert if requested
      if (autoplay === 'true') {
        setTimeout(() => convertBtn.click(), 500);
      }
    } else {
      // Handle shared URL
      const sharedUrl = urlParams.get('url');
      if (sharedUrl) {
        const urlMatch = sharedUrl.match(/https?:\/\/[^\s]+/);
        if (urlMatch) {
          urlInput.value = urlMatch[0];
        } else {
          urlInput.value = sharedUrl;
        }
      }
    }

    // Clean up URL (remove params after reading)
    if (urlParams.toString()) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // PWA Install prompt
    let deferredPrompt;
    const installPrompt = document.getElementById('install-prompt');
    const installBtn = document.getElementById('install-btn');
    const dismissBtn = document.getElementById('dismiss-install');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('visible');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const result = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installPrompt.classList.remove('visible');
    });

    dismissBtn.addEventListener('click', () => {
      installPrompt.classList.remove('visible');
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Helix Listen</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e8e8e8;
      padding: 20px;
      padding-bottom: 100px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tagline {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }

    .input-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 8px;
    }

    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #e94560;
    }

    .file-input-wrapper {
      position: relative;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 16px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-input-label:hover {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.1);
    }

    .file-input-label.has-file {
      border-style: solid;
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }

    input[type="file"] {
      display: none;
    }

    .divider {
      text-align: center;
      color: #666;
      margin: 15px 0;
      font-size: 0.8rem;
    }

    .options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .option {
      flex: 1;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #e94560;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(233, 69, 96, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      display: none;
    }

    .status.loading {
      display: block;
      background: rgba(233, 69, 96, 0.1);
      border: 1px solid rgba(233, 69, 96, 0.3);
    }

    .status.error {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    .status.success {
      display: block;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }

    .player-section {
      display: none;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }

    .player-section.visible {
      display: block;
    }

    .article-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: #fff;
    }

    .article-meta {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 15px;
    }

    audio {
      width: 100%;
      margin-top: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .download-btn {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .download-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      max-width: 500px;
      margin: 0 auto;
      background: #2a2a4a;
      padding: 15px 20px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .install-prompt.visible {
      display: flex;
    }

    .install-prompt p {
      flex: 1;
      font-size: 0.9rem;
    }

    .install-prompt button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .install-btn {
      background: #e94560;
      color: white;
    }

    .dismiss-btn {
      background: transparent;
      color: #888;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #666;
      font-size: 0.8rem;
    }

    .footer a {
      color: #e94560;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéß Helix Listen</h1>
    <p class="tagline">Turn any article or PDF into audio</p>

    <div class="input-section">
      <div class="input-group">
        <label for="url-input">Paste article URL</label>
        <input type="url" id="url-input" placeholder="https://example.com/article">
      </div>

      <div class="divider">‚Äî or ‚Äî</div>

      <div class="input-group">
        <label>Upload a PDF</label>
        <div class="file-input-wrapper">
          <label class="file-input-label" id="file-label">
            <span>üìÑ</span>
            <span id="file-name">Choose PDF file</span>
          </label>
          <input type="file" id="pdf-input" accept=".pdf">
        </div>
      </div>

      <div class="options">
        <div class="option">
          <label for="voice-select">Voice</label>
          <select id="voice-select">
            <option value="alloy">Alloy (Neutral)</option>
            <option value="echo">Echo (Male)</option>
            <option value="fable">Fable (British)</option>
            <option value="onyx">Onyx (Deep)</option>
            <option value="nova">Nova (Female)</option>
            <option value="shimmer">Shimmer (Soft)</option>
          </select>
        </div>
        <div class="option">
          <label for="speed-select">Speed</label>
          <select id="speed-select">
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary" id="convert-btn">
        <span>üéôÔ∏è</span>
        <span>Convert to Audio</span>
      </button>

      <div class="status" id="status"></div>
    </div>

    <div class="player-section" id="player-section">
      <div class="article-title" id="article-title"></div>
      <div class="article-meta" id="article-meta"></div>
      <audio id="audio-player" controls></audio>
      <button class="btn download-btn" id="download-btn">
        <span>‚¨áÔ∏è</span>
        <span>Download MP3</span>
      </button>
    </div>

    <footer class="footer">
      Suhit Anantula | <a href="https://suhitanantula.com" target="_blank">suhitanantula.com</a>
    </footer>
  </div>

  <div class="install-prompt" id="install-prompt">
    <p>Install Helix Listen for quick access from your home screen</p>
    <button class="dismiss-btn" id="dismiss-install">Later</button>
    <button class="install-btn" id="install-btn">Install</button>
  </div>

  <script>
    // Elements
    const urlInput = document.getElementById('url-input');
    const pdfInput = document.getElementById('pdf-input');
    const fileLabel = document.getElementById('file-label');
    const fileName = document.getElementById('file-name');
    const voiceSelect = document.getElementById('voice-select');
    const speedSelect = document.getElementById('speed-select');
    const convertBtn = document.getElementById('convert-btn');
    const status = document.getElementById('status');
    const playerSection = document.getElementById('player-section');
    const articleTitle = document.getElementById('article-title');
    const articleMeta = document.getElementById('article-meta');
    const audioPlayer = document.getElementById('audio-player');
    const downloadBtn = document.getElementById('download-btn');

    let currentAudioBlob = null;
    let currentTitle = '';

    // Handle PDF file selection
    pdfInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        fileName.textContent = file.name;
        fileLabel.classList.add('has-file');
        urlInput.value = ''; // Clear URL if PDF selected
      }
    });

    // Clear PDF when URL is entered
    urlInput.addEventListener('input', () => {
      if (urlInput.value) {
        pdfInput.value = '';
        fileName.textContent = 'Choose PDF file';
        fileLabel.classList.remove('has-file');
      }
    });

    // Convert button handler
    convertBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      const pdfFile = pdfInput.files[0];

      if (!url && !pdfFile) {
        showStatus('Please enter a URL or upload a PDF', 'error');
        return;
      }

      convertBtn.disabled = true;
      convertBtn.innerHTML = '<div class="spinner"></div><span>Processing...</span>';
      playerSection.classList.remove('visible');

      try {
        // Step 1: Extract text
        showStatus('Extracting text...', 'loading');

        let extractBody = {};
        if (url) {
          extractBody = { url };
        } else if (pdfFile) {
          const base64 = await fileToBase64(pdfFile);
          extractBody = { pdfBase64: base64 };
        }

        const extractRes = await fetch('/api/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(extractBody),
        });

        if (!extractRes.ok) {
          const err = await extractRes.json();
          throw new Error(err.error || 'Failed to extract text');
        }

        const extracted = await extractRes.json();
        currentTitle = extracted.title;

        // Step 2: Convert to speech
        showStatus(`Converting ${extracted.wordCount} words to speech (~${extracted.estimatedMinutes} min)...`, 'loading');

        const voice = voiceSelect.value;
        const speed = parseFloat(speedSelect.value);

        const speakRes = await fetch('/api/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: extracted.text,
            voice,
            speed,
          }),
        });

        if (!speakRes.ok) {
          const err = await speakRes.json();
          throw new Error(err.error || 'Failed to generate speech');
        }

        // Create audio blob
        currentAudioBlob = await speakRes.blob();
        const audioUrl = URL.createObjectURL(currentAudioBlob);

        // Update player
        articleTitle.textContent = extracted.title;
        articleMeta.textContent = `${extracted.wordCount} words ‚Ä¢ ~${extracted.estimatedMinutes} min`;
        audioPlayer.src = audioUrl;
        playerSection.classList.add('visible');

        showStatus('Ready to play!', 'success');

        // Auto-play
        audioPlayer.play();

      } catch (error) {
        console.error(error);
        showStatus(error.message, 'error');
      } finally {
        convertBtn.disabled = false;
        convertBtn.innerHTML = '<span>üéôÔ∏è</span><span>Convert to Audio</span>';
      }
    });

    // Download handler
    downloadBtn.addEventListener('click', () => {
      if (!currentAudioBlob) return;

      const url = URL.createObjectURL(currentAudioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentTitle.replace(/[^a-z0-9]/gi, '_')}.mp3`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Helper functions
    function showStatus(message, type) {
      status.textContent = message;
      status.className = 'status ' + type;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Handle share target (when app receives shared URL)
    const urlParams = new URLSearchParams(window.location.search);
    const sharedUrl = urlParams.get('url') || urlParams.get('text');
    if (sharedUrl) {
      // Extract URL from shared text if needed
      const urlMatch = sharedUrl.match(/https?:\/\/[^\s]+/);
      if (urlMatch) {
        urlInput.value = urlMatch[0];
      } else {
        urlInput.value = sharedUrl;
      }
    }

    // PWA Install prompt
    let deferredPrompt;
    const installPrompt = document.getElementById('install-prompt');
    const installBtn = document.getElementById('install-btn');
    const dismissBtn = document.getElementById('dismiss-install');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('visible');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const result = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installPrompt.classList.remove('visible');
    });

    dismissBtn.addEventListener('click', () => {
      installPrompt.classList.remove('visible');
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
